
<!DOCTYPE html>
<HTML>
<HEAD>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <TITLE>
        Dybdekart av hafsfjorden
    </TITLE>
</HEAD>
<BODY>
    <div class="header">
        <a href="#default" class="logo">CompanyLogo</a>
        <div class="header-right">
            <a class="active" href="#home">Home</a>
            <a href="/kart">Kart</a>
            <a href="#about">About</a>
        </div>
    </div>

    <div id="myDiv" ondblclick="Contour(100,0)"></div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3-contour.v1.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
   
    <button type="button" id="3d-knapp" onclick="plot3d()">3D!</button>
    <button type="button" id="contour-knapp" onclick="tilbake_til_contour()" disabled>Contour!</button>
    <div class="footer">
        <p>Footer</p>
    </div>
    <script>
        var xstart;
        var xslutt;
        var zoomet;
        var myplot = document.getElementById('myDiv')
        //definerer variabler
        Contour(100,0)
        //første gang plotet blir lastet   
        function Contour(zoom, eventdata) {
      
            if (zoom == 100) {
                xstart = 6534927.09;
                xslutt = 6534882.22;
                zoomet=zoom
                //Denne funksjonen kjører når siden blir lastet eller når du zoomer ut
                var vars = "&zoom=" + zoom
                //Definerer variablene som skal sendes til serveren

                var request = new XMLHttpRequest();
                request.onreadystatechange = function () {
                    if (request.readyState == 4) {
                        res = request.response;
                        act_on_resp(res, zoom-25)
                    }
                }
                request.open('POST', 'http://127.0.0.1:5000/firstzoom');
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                request.send(vars);
            }
            else {
                xstart = eventdata['xaxis.range[0]']
                xslutt = eventdata['xaxis.range[1]']
                var vars = "xcoord=" + xstart + "&xcoord1=" + xslutt + "&zoom=" + zoom
                zoomet=zoom
                var request = new XMLHttpRequest();
                request.onreadystatechange = function () {
                    if (request.readyState == 4) {

                        res = request.response;
                        resp = JSON.parse(res);
                        if (resp === undefined || resp.length == 0) {
                            console.log("")
                        }
                        else {
                            act_on_resp(res, zoom-25);
                        }
                    }
                }
                request.open('POST', 'http://127.0.0.1:5000/zoom');
                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                request.send(vars);

            }
        }
        function tilbake_til_contour() {
            document.getElementById("contour-knapp").disabled = true;
            document.getElementById("3d-knapp").disabled = false;
            var vars = "xcoord=" + xstart + "&xcoord1=" + xslutt + "&zoom=" + zoomet
      
            console.log(zoomet);
            console.log(xstart);
            console.log(xslutt);

            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (request.readyState == 4) {

                    res = request.response;
                    resp = JSON.parse(res);
                    if (resp === undefined || resp.length == 0) {
                        console.log("")
                    }
                    else {
                        act_on_resp(res, zoomet);
                    }
                }
            }
            request.open('POST', 'http://127.0.0.1:5000/zoom');
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            request.send(vars);

        }
        

        function act_on_resp(resp, zoom) {
            coords = JSON.parse(res);
            console.log(coords)
            console.log(coords["x"])
            var data = [{
                z: coords["z"],
                x: coords["x"],
                y: coords["y"],
                type: 'contour'
            }];
            var layout = {
                title: 'Basic Contour Plot'
            }
            console.log(data)
            console.log(zoomet);
            console.log(xstart);
            console.log(xslutt);

          
            
            Plotly.newPlot('myDiv', data, layout);
           myDiv.on('plotly_doubleclick', function () {
                    zoom = 100
                    console.log(zoomet)      
            });   
            myDiv.on('plotly_relayout',
                function (eventdata) {
                    if (zoom == 100) {
                        Contour(100, 0)
                        return;
                    }
                    if (zoomet - 25 == 0) {
                        Contour(1, eventdata)
                        zoomet = 1;
                        return;
                    }
                    if (zoomet == 1) {
                        console.log("Tester123")
                        return;
                    }
                    Contour(zoom, eventdata)
                });
        }
        function plot3d() {
            document.getElementById("contour-knapp").disabled = false;
            document.getElementById("3d-knapp").disabled = true;

            var vars1 = "xcoord=" + xstart + "&xcoord1=" + xslutt + "&zoom=" + 10

            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (request.readyState == 4) {
                    res = request.response;
                    console.log(res);
                    plot(res);


                }
            }
            request.open('POST', 'http://127.0.0.1:5000/treD');
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            request.send(vars1);

        }

        function plot(res) {
            var coords = []
            coords = JSON.parse(res);

            Plotly.d3.csv('https://raw.githubusercontent.com/plotly/datasets/master/api_docs/mt_bruno_elevation.csv', function (err, rows) {
                function unpack(rows, key) {
                    return rows.map(function (row) { return row[key]; });
                }

                /*var z_data = []
                var data = []
                var z=0
                for (i = 0; i < coords['x'].length; i++) {
                    data[z] = coords['z'][i]
                    z++
                    if (i %Math.floor(Math.sqrt(coords['z'].length)) == 0) {
                        if (i > 2) {
                            z_data.push(data);
                            data = []
                            z = 0
                        }
                    }
                    console.log(coords['z'].length)
                }
                console.log(z_data)
                */
                console.log(coords)
                console.log(coords.length)
                var data = [{
                    z: coords,
                    type: 'surface'
                }];

                var layout = {
                    title: 'Kart over Hafsfjorden mellom ' + xstart + " og " + xslutt,
                    autosize: false,
                    width: 1000,
                    height: 600,
                    margin: {
                        l: 65,
                        r: 50,
                        b: 65,
                        t: 90,
                    }
                };
                Plotly.newPlot('myDiv', data, layout);
            });
        }
    </script>
</BODY>
</HTML>